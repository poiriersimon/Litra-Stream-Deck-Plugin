<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adjust Temperature</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            margin: 0; 
            padding: 8px 12px; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
            font-size: 9pt;
            color: #d8d8d8;
            background: transparent;
        }
        .sdpi-item { 
            margin: 0 0 12px 0;
            display: flex;
            flex-direction: column;
        }
        .sdpi-item-label { 
            display: block; 
            margin-bottom: 4px;
            font-size: 9pt;
            font-weight: 500;
        }
        select, input[type="number"] { 
            width: 100%; 
            padding: 4px 6px;
            background: #3d3d3d;
            border: 1px solid #2d2d2d;
            color: #d8d8d8;
            border-radius: 3px;
            font-size: 9pt;
        }
        select:focus, input:focus {
            outline: none;
            border-color: #5a9fd4;
        }
    </style>
</head>
<body>
    <div class="sdpi-item">
        <label class="sdpi-item-label" for="devicePath">Device</label>
        <select id="devicePath" setting="devicePath">
            <option value="all">Loading devices...</option>
        </select>
    </div>

    <div class="sdpi-item">
        <label class="sdpi-item-label" for="step">Step (K)</label>
        <input type="number" id="step" setting="step" min="1" max="1000" value="100">
    </div>

    <script>
        let allDevices = [];
        let savedSettings = {};
        let devicesReceived = 0;

        // Override connection to handle everything in one WebSocket
        window.connectElgatoStreamDeckSocket = function(inPort, inUUID, inRegisterEvent, inInfo, inActionInfo) {
            const actionData = JSON.parse(inActionInfo);
            savedSettings = actionData.payload?.settings || {};
            
            // Load existing settings into form
            if (savedSettings.step) {
                document.getElementById('step').value = savedSettings.step;
            }
            
            const ws = new WebSocket('ws://127.0.0.1:' + inPort);
            
            ws.onopen = function() {
                ws.send(JSON.stringify({
                    event: inRegisterEvent,
                    uuid: inUUID
                }));
                
                // Request both Beam and Glow devices
                ws.send(JSON.stringify({
                    event: 'sendToPlugin',
                    context: inUUID,
                    action: actionData.action,
                    payload: {
                        event: 'getDevices',
                        deviceType: 'Beam'
                    }
                }));
                ws.send(JSON.stringify({
                    event: 'sendToPlugin',
                    context: inUUID,
                    action: actionData.action,
                    payload: {
                        event: 'getDevices',
                        deviceType: 'Glow'
                    }
                }));
            };
            
            ws.onmessage = function(evt) {
                const jsonObj = JSON.parse(evt.data);
                
                // Handle device list responses
                if (jsonObj.event === 'sendToPropertyInspector' && jsonObj.payload?.event === 'deviceList') {
                    allDevices = allDevices.concat(jsonObj.payload.devices);
                    devicesReceived++;
                    // Wait for both device lists before populating
                    if (devicesReceived >= 2) {
                        populateDeviceDropdown();
                    }
                }
                
                // Handle settings updates
                if (jsonObj.event === 'didReceiveSettings') {
                    const newSettings = jsonObj.payload.settings || {};
                    savedSettings = newSettings;
                    // Update form with new settings
                    if (newSettings.devicePath) {
                        document.getElementById('devicePath').value = newSettings.devicePath;
                    }
                    if (newSettings.step !== undefined) {
                        document.getElementById('step').value = newSettings.step;
                    }
                }
            };
            
            // Add change listeners for all elements with setting attribute
            document.querySelectorAll('[setting]').forEach(element => {
                element.addEventListener('change', function() {
                    const settingName = this.getAttribute('setting');
                    let value = this.value;
                    
                    if (this.type === 'number') {
                        value = parseInt(this.value, 10);
                    }
                    
                    savedSettings[settingName] = value;
                    
                    ws.send(JSON.stringify({
                        event: 'setSettings',
                        context: inUUID,
                        payload: savedSettings
                    }));
                });
            });
        };

        // Populate the device dropdown
        function populateDeviceDropdown() {
            const select = document.getElementById('devicePath');
            if (!select) return;
            
            // Clear existing options and add "All Lights"
            select.innerHTML = '<option value="all">All Lights</option>';
            
            if (allDevices.length === 0) {
                return;
            }
            
            // Add device options
            allDevices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.value;
                option.textContent = device.text || device.label;
                select.appendChild(option);
            });
            
            // Restore saved device selection if available
            if (savedSettings && savedSettings.devicePath) {
                select.value = savedSettings.devicePath;
            }
        }
    </script>
</body>
</html>
